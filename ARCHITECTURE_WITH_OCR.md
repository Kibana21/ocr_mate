# OCR Mate Architecture - Complete Flow

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           OCR MATE PLATFORM                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    FRONTEND (HTML/CSS/JS)                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚ Document     â”‚  â”‚ Schema       â”‚  â”‚ Annotation   â”‚             â”‚   â”‚
â”‚  â”‚  â”‚ Type Manager â”‚  â”‚ Editor       â”‚  â”‚ UI           â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚         â”‚                 â”‚                  â”‚                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                 â”‚                  â”‚                           â”‚
â”‚            â”‚                 â”‚                  â”‚                           â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â”‚ HTTP REST API                                â”‚
â”‚                              â†“                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    BACKEND API (FastAPI)                            â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  POST /api/annotations/create         â† Upload document             â”‚   â”‚
â”‚  â”‚  PUT  /api/annotations/{id}/fields    â† Edit field value            â”‚   â”‚
â”‚  â”‚  POST /api/annotations/{id}/verify    â† Verify field                â”‚   â”‚
â”‚  â”‚  POST /api/optimize                   â† Start GEPA optimization     â”‚   â”‚
â”‚  â”‚  POST /api/extractions/process        â† Process new document        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â†“                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SERVICE LAYER                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  OCR Service (services/ocr/)                                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ AzureDocumentIntelligenceService                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Extracts text, layout, bounding boxes                    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                              â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Annotation Service (services/models/annotation.py)          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ OCRAssistedAnnotationService                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Creates pre-filled annotations from OCR                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Tracks field sources (OCR auto, user edited, manual)     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                              â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  GEPA Optimizer (services/gepa/)                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ GEPAOptimizer (orchestrator)                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ SchemaAdapter (schema â†’ DSPy signature)                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ MetricFactory (creates GEPA metrics)                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ TrainingDataConverter (converts ground truth)            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ImageProcessor (loads & resizes images)                  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                              â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Verification Service (services/models/verification.py)      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ DualExtractionVerifier                                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Runs OCR + LLM extraction in parallel                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Compares results field-by-field                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Generates confidence scores & flags conflicts            â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â†“                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    EXTERNAL SERVICES                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ Azure Document       â”‚  â”‚ LLM APIs             â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ Intelligence         â”‚  â”‚ - Gemini             â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ (OCR)                â”‚  â”‚ - OpenAI GPT-4       â”‚               â”‚   â”‚
â”‚  â”‚  â”‚                      â”‚  â”‚ - Claude 3.5         â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Workflow 1: Creating Ground Truth with OCR Assistance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER: Create Ground Truth Example                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 1: User defines schema                 â”‚
          â”‚  - merchant_name (TEXT)                      â”‚
          â”‚  - transaction_date (DATE)                   â”‚
          â”‚  - total (CURRENCY)                          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 2: User uploads document               â”‚
          â”‚  ğŸ“„ receipt_123.jpg                          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 3: System runs OCR                     â”‚
          â”‚  AzureDocumentIntelligenceService            â”‚
          â”‚    .extract_text(receipt_123.jpg)            â”‚
          â”‚                                              â”‚
          â”‚  Returns:                                    â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ OCRResult                              â”‚ â”‚
          â”‚  â”‚  pages: [OCRPage]                      â”‚ â”‚
          â”‚  â”‚  full_text: "Store ABC\n               â”‚ â”‚
          â”‚  â”‚              Date: 01/15/2024\n        â”‚ â”‚
          â”‚  â”‚              Total: $25.99"            â”‚ â”‚
          â”‚  â”‚  lines: [OCRLine with bounding boxes] â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 4: System matches OCR to schema        â”‚
          â”‚  OCRAssistedAnnotationService                â”‚
          â”‚    .create_annotation(doc, schema)           â”‚
          â”‚                                              â”‚
          â”‚  Uses keyword matching:                      â”‚
          â”‚  - "merchant_name" â†’ finds "Store ABC"       â”‚
          â”‚  - "date" â†’ finds "01/15/2024"               â”‚
          â”‚  - "total" â†’ finds "$25.99"                  â”‚
          â”‚                                              â”‚
          â”‚  Returns:                                    â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ DocumentAnnotation                     â”‚ â”‚
          â”‚  â”‚  annotations: [                        â”‚ â”‚
          â”‚  â”‚    FieldAnnotation(                    â”‚ â”‚
          â”‚  â”‚      field_name="merchant_name"        â”‚ â”‚
          â”‚  â”‚      value="Store ABC"                 â”‚ â”‚
          â”‚  â”‚      source=OCR_AUTO                   â”‚ â”‚
          â”‚  â”‚      ocr_confidence=0.75               â”‚ â”‚
          â”‚  â”‚      user_verified=False               â”‚ â”‚
          â”‚  â”‚    ),                                  â”‚ â”‚
          â”‚  â”‚    FieldAnnotation(...)                â”‚ â”‚
          â”‚  â”‚  ]                                     â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 5: UI displays pre-filled form         â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ Merchant Name: Store ABC         âœ“ â”‚âš ï¸â”‚ â”‚
          â”‚  â”‚ Date:          01/15/2024        âœ“ â”‚  â”‚ â”‚
          â”‚  â”‚ Total:         $25.99            âœ“ â”‚âš ï¸â”‚ â”‚
          â”‚  â”‚                                      â”‚ â”‚ â”‚
          â”‚  â”‚ âœ“ = Verify button                    â”‚ â”‚
          â”‚  â”‚ âš ï¸ = Low confidence indicator         â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 6: User reviews and corrects           â”‚
          â”‚                                              â”‚
          â”‚  User actions:                               â”‚
          â”‚  âœ… Clicks âœ“ on "merchant_name" (verified)   â”‚
          â”‚  âœ… Clicks âœ“ on "date" (verified)            â”‚
          â”‚  âœï¸ Edits "total" from $25.99 â†’ $26.49       â”‚
          â”‚                                              â”‚
          â”‚  Backend updates:                            â”‚
          â”‚  annotation.mark_field_verified("merchant")  â”‚
          â”‚  annotation.mark_field_verified("date")      â”‚
          â”‚  annotation.set_field_value(                 â”‚
          â”‚    "total", 26.49, USER_EDITED               â”‚
          â”‚  )                                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 7: Check completion                    â”‚
          â”‚  annotation.get_completion_status(schema)    â”‚
          â”‚                                              â”‚
          â”‚  Returns:                                    â”‚
          â”‚  {                                           â”‚
          â”‚    "annotated_fields": 3,                    â”‚
          â”‚    "verified_fields": 3,                     â”‚
          â”‚    "is_complete": True âœ“                     â”‚
          â”‚  }                                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 8: Save as ground truth                â”‚
          â”‚                                              â”‚
          â”‚  ground_truth = GroundTruthExample(          â”‚
          â”‚    document_path="receipt_123.jpg",          â”‚
          â”‚    labeled_values={                          â”‚
          â”‚      "merchant_name": "Store ABC",           â”‚
          â”‚      "transaction_date": "01/15/2024",       â”‚
          â”‚      "total": 26.49  â† User corrected        â”‚
          â”‚    }                                         â”‚
          â”‚  )                                           â”‚
          â”‚                                              â”‚
          â”‚  database.save(ground_truth)                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  âœ… Ground truth created!                     â”‚
          â”‚                                              â”‚
          â”‚  Time saved: ~5 minutes (only 1 correction)  â”‚
          â”‚  vs. typing all 3 fields manually            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Workflow 2: GEPA Optimization (Unchanged)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER: Optimize Pipeline with 5 Ground Truth Examples                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 1: User clicks "Optimize"              â”‚
          â”‚                                              â”‚
          â”‚  Input:                                      â”‚
          â”‚  - schema (ReceiptSchema)                    â”‚
          â”‚  - ground_truth_examples (5 annotated docs)  â”‚
          â”‚  - config (LLM settings, GEPA params)        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 2: GEPAOptimizer.optimize()            â”‚
          â”‚                                              â”‚
          â”‚  2.1: SchemaAdapter converts schema          â”‚
          â”‚       â†’ Creates dynamic Pydantic model       â”‚
          â”‚       â†’ Creates DSPy Signature               â”‚
          â”‚                                              â”‚
          â”‚  2.2: MetricFactory creates metric           â”‚
          â”‚       â†’ 5-parameter GEPA metric              â”‚
          â”‚       â†’ Field-specific feedback              â”‚
          â”‚                                              â”‚
          â”‚  2.3: TrainingDataConverter converts data    â”‚
          â”‚       â†’ Loads images                         â”‚
          â”‚       â†’ Creates dspy.Example objects         â”‚
          â”‚       â†’ 80/20 train/val split                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 3: GEPA optimization runs              â”‚
          â”‚                                              â”‚
          â”‚  3.1: Create baseline program                â”‚
          â”‚       baseline = dspy.Predict(Signature)     â”‚
          â”‚                                              â”‚
          â”‚  3.2: Run GEPA                               â”‚
          â”‚       optimizer = dspy.GEPA(                 â”‚
          â”‚         metric=metric_fn,                    â”‚
          â”‚         num_threads=1,                       â”‚
          â”‚         reflection_lm=reflection_llm         â”‚
          â”‚       )                                      â”‚
          â”‚       optimized = optimizer.compile(         â”‚
          â”‚         student=baseline,                    â”‚
          â”‚         trainset=train_examples              â”‚
          â”‚       )                                      â”‚
          â”‚                                              â”‚
          â”‚  3.3: GEPA iterates:                         â”‚
          â”‚       â†’ Student LLM extracts fields          â”‚
          â”‚       â†’ Metric compares to ground truth      â”‚
          â”‚       â†’ Reflection LLM generates feedback    â”‚
          â”‚       â†’ Prompts improved with feedback       â”‚
          â”‚       â†’ Repeat until optimal                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 4: Save optimized pipeline             â”‚
          â”‚                                              â”‚
          â”‚  optimized.save(                             â”‚
          â”‚    "pipelines/receipt_optimized.json"        â”‚
          â”‚  )                                           â”‚
          â”‚                                              â”‚
          â”‚  Returns:                                    â”‚
          â”‚  OptimizationResult(                         â”‚
          â”‚    success=True,                             â”‚
          â”‚    metrics={                                 â”‚
          â”‚      baseline_accuracy: 0.60,                â”‚
          â”‚      optimized_accuracy: 0.92,               â”‚
          â”‚      improvement: 53%                        â”‚
          â”‚    }                                         â”‚
          â”‚  )                                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  âœ… Pipeline optimized and ready!             â”‚
          â”‚                                              â”‚
          â”‚  Pipeline saved to:                          â”‚
          â”‚  pipelines/receipt_optimized.json            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Workflow 3: Production Extraction with Dual Verification

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER: Process New Document with Verification                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 1: User uploads new document           â”‚
          â”‚  ğŸ“„ new_receipt.jpg                          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 2: Load optimized pipeline             â”‚
          â”‚  llm_extractor = dspy.Predict.load(          â”‚
          â”‚    "pipelines/receipt_optimized.json"        â”‚
          â”‚  )                                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 3: Create verifier                     â”‚
          â”‚  verifier = DualExtractionVerifier(          â”‚
          â”‚    ocr_service=ocr_service,                  â”‚
          â”‚    llm_extractor=llm_extractor,              â”‚
          â”‚    conflict_strategy=HIGHER_CONFIDENCE       â”‚
          â”‚  )                                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 4: Run dual extraction (PARALLEL)      â”‚
          â”‚                                              â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ OCR Extraction     â”‚  â”‚ LLM Extraction â”‚ â”‚
          â”‚  â”‚ (Fast, Cheap)      â”‚  â”‚ (Smart, Slow)  â”‚ â”‚
          â”‚  â”‚                    â”‚  â”‚                â”‚ â”‚
          â”‚  â”‚ Azure Doc Intel    â”‚  â”‚ Optimized      â”‚ â”‚
          â”‚  â”‚  .extract_text()   â”‚  â”‚ Pipeline       â”‚ â”‚
          â”‚  â”‚                    â”‚  â”‚  (image)       â”‚ â”‚
          â”‚  â”‚ Returns:           â”‚  â”‚                â”‚ â”‚
          â”‚  â”‚ {                  â”‚  â”‚ Returns:       â”‚ â”‚
          â”‚  â”‚   merchant: "ABC"  â”‚  â”‚ {              â”‚ â”‚
          â”‚  â”‚   date: "01/15"    â”‚  â”‚   merchant:    â”‚ â”‚
          â”‚  â”‚   total: "$26.50"  â”‚  â”‚     "ABC"      â”‚ â”‚
          â”‚  â”‚ }                  â”‚  â”‚   date:        â”‚ â”‚
          â”‚  â”‚ confidence: 0.7    â”‚  â”‚     "01/15"    â”‚ â”‚
          â”‚  â”‚                    â”‚  â”‚   total:       â”‚ â”‚
          â”‚  â”‚                    â”‚  â”‚     "$26.49"   â”‚ â”‚
          â”‚  â”‚                    â”‚  â”‚ }              â”‚ â”‚
          â”‚  â”‚                    â”‚  â”‚ confidence:0.9 â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 5: Compare results field-by-field      â”‚
          â”‚                                              â”‚
          â”‚  For each field:                             â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ Field: merchant_name                   â”‚ â”‚
          â”‚  â”‚   OCR: "ABC" (conf: 0.7)               â”‚ â”‚
          â”‚  â”‚   LLM: "ABC" (conf: 0.9)               â”‚ â”‚
          â”‚  â”‚   Match? YES âœ“                         â”‚ â”‚
          â”‚  â”‚   Final: "ABC"                         â”‚ â”‚
          â”‚  â”‚   Confidence: 0.85 (boosted by match)  â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â”‚                                              â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ Field: total                           â”‚ â”‚
          â”‚  â”‚   OCR: "$26.50" (conf: 0.7)            â”‚ â”‚
          â”‚  â”‚   LLM: "$26.49" (conf: 0.9)            â”‚ â”‚
          â”‚  â”‚   Match? NO (within 1% tolerance) âœ“    â”‚ â”‚
          â”‚  â”‚   Status: MATCH (normalized)           â”‚ â”‚
          â”‚  â”‚   Final: "$26.49" (prefer LLM)         â”‚ â”‚
          â”‚  â”‚   Confidence: 0.85                     â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 6: Calculate metrics                   â”‚
          â”‚                                              â”‚
          â”‚  overall_confidence = avg(field_confidences) â”‚
          â”‚                     = 0.85                   â”‚
          â”‚                                              â”‚
          â”‚  match_rate = matches / total_fields         â”‚
          â”‚             = 3 / 3 = 100%                   â”‚
          â”‚                                              â”‚
          â”‚  needs_review = confidence < 0.6             â”‚
          â”‚               = False                        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 7: Route based on confidence           â”‚
          â”‚                                              â”‚
          â”‚  if confidence >= 0.9:                       â”‚
          â”‚    âœ… AUTO-APPROVE                            â”‚
          â”‚    Save extraction with status="approved"    â”‚
          â”‚                                              â”‚
          â”‚  elif confidence >= 0.6:                     â”‚
          â”‚    âš ï¸ AUTO-SAVE, FLAG FOR SPOT CHECK         â”‚
          â”‚    Save extraction with status="review"      â”‚
          â”‚                                              â”‚
          â”‚  else:                                       â”‚
          â”‚    âŒ HUMAN REVIEW REQUIRED                   â”‚
          â”‚    Add to review queue with conflicts        â”‚
          â”‚                                              â”‚
          â”‚  In this case: 0.85 â‰¥ 0.6 â†’ Auto-save       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 8: Return result to user               â”‚
          â”‚                                              â”‚
          â”‚  {                                           â”‚
          â”‚    "extraction": {                           â”‚
          â”‚      "merchant_name": "ABC",                 â”‚
          â”‚      "date": "01/15/2024",                   â”‚
          â”‚      "total": 26.49                          â”‚
          â”‚    },                                        â”‚
          â”‚    "confidence": 0.85,                       â”‚
          â”‚    "match_rate": 1.0,                        â”‚
          â”‚    "status": "approved",                     â”‚
          â”‚    "needs_review": false                     â”‚
          â”‚  }                                           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  âœ… Extraction complete with confidence!      â”‚
          â”‚                                              â”‚
          â”‚  Benefits:                                   â”‚
          â”‚  - Know extraction is trustworthy (85% conf) â”‚
          â”‚  - OCR + LLM agree (100% match rate)         â”‚
          â”‚  - Auto-approved (no manual review needed)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATA MODELS & FLOW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Schema Definition (User Input)
   â†“
   ExtractionSchema {
     version: 1,
     fields: [
       FieldDefinition {
         name: "merchant_name",
         data_type: FieldType.TEXT,
         required: true,
         extraction_hints: ["Store name", "Merchant"]
       },
       ...
     ]
   }

2. Ground Truth Annotation (OCR-Assisted)
   â†“
   DocumentAnnotation {
     document_path: "receipt_1.jpg",
     annotations: [
       FieldAnnotation {
         field_name: "merchant_name",
         value: "Store ABC",
         source: AnnotationSource.OCR_AUTO,
         ocr_confidence: 0.75,
         user_verified: false
       },
       ...
     ]
   }
   â†“
   (User reviews and verifies)
   â†“
   GroundTruthExample {
     document_path: "receipt_1.jpg",
     labeled_values: {
       "merchant_name": "Store ABC",
       "total": 26.49
     }
   }

3. GEPA Optimization
   â†“
   OptimizationConfig {
     student_llm: LLMConfig,
     reflection_llm: LLMConfig,
     gepa: GEPAConfig
   }
   â†“
   GEPAOptimizer.optimize(ground_truth_examples)
   â†“
   OptimizationResult {
     success: true,
     metrics: OptimizationMetrics {
       baseline_accuracy: 0.60,
       optimized_accuracy: 0.92
     },
     artifacts: {
       "saved_path": "pipelines/optimized.json"
     }
   }

4. Production Extraction with Verification
   â†“
   DualExtractionVerifier.verify_extraction(new_document)
   â†“
   DocumentVerification {
     field_verifications: [
       FieldVerification {
         field_name: "merchant_name",
         ocr_value: "ABC",
         llm_value: "ABC",
         final_value: "ABC",
         status: VerificationStatus.MATCH,
         confidence_score: 0.85
       },
       ...
     ],
     overall_confidence: 0.85,
     match_rate: 1.0,
     needs_human_review: false
   }
   â†“
   Final Extraction {
     "merchant_name": "ABC",
     "total": 26.49,
     "_metadata": {
       "confidence": 0.85,
       "status": "approved"
     }
   }
```

---

## File Organization

```
ocr_mate/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                          # Data models
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ schema.py                    # ExtractionSchema, FieldDefinition
â”‚   â”‚   â”œâ”€â”€ annotation.py                # NEW: OCR-assisted annotation
â”‚   â”‚   â”œâ”€â”€ verification.py              # NEW: Dual extraction verification
â”‚   â”‚   â”œâ”€â”€ optimization_config.py       # LLMConfig, GEPAConfig
â”‚   â”‚   â””â”€â”€ optimization_result.py       # OptimizationResult, metrics
â”‚   â”‚
â”‚   â”œâ”€â”€ ocr/                             # NEW: OCR services
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ azure_service.py             # Azure Document Intelligence client
â”‚   â”‚
â”‚   â”œâ”€â”€ gepa/                            # GEPA optimization
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ optimizer.py                 # Main GEPAOptimizer
â”‚   â”‚   â”œâ”€â”€ schema_adapter.py            # Schema â†’ DSPy Signature
â”‚   â”‚   â”œâ”€â”€ metric_factory.py            # Create GEPA metrics
â”‚   â”‚   â”œâ”€â”€ training_data.py             # Convert ground truth
â”‚   â”‚   â”œâ”€â”€ image_processor.py           # Load & resize images
â”‚   â”‚   â””â”€â”€ README.md
â”‚   â”‚
â”‚   â”œâ”€â”€ OCR_INTEGRATION_GUIDE.md         # NEW: Comprehensive OCR guide
â”‚   â””â”€â”€ OCR_ENHANCEMENT_SUMMARY.md       # NEW: Quick summary
â”‚
â”œâ”€â”€ test_gepa_service.py                 # Original GEPA test
â”œâ”€â”€ test_ocr_verification.py             # NEW: OCR workflow tests
â”œâ”€â”€ gepa_receipt_optimization.py         # Original receipt script
â””â”€â”€ REQUIREMENTS.md                      # Product requirements
```

---

## Key Architectural Decisions

### 1. OCR Integration is Optional

```python
# Without OCR (still works)
optimizer = GEPAOptimizer(schema, config)
result = optimizer.optimize(ground_truth_examples)

# With OCR annotation (faster ground truth creation)
annotation_service = OCRAssistedAnnotationService(ocr_service)
annotation = annotation_service.create_annotation(doc, schema)
ground_truth = annotation.to_ground_truth()

# With OCR verification (confidence scoring)
verifier = DualExtractionVerifier(ocr_service, llm_extractor)
verification = verifier.verify_extraction(doc, schema)
```

### 2. Two Separate OCR Use Cases

**Use Case 1: Annotation** (Always beneficial)
- Pre-fills forms â†’ Saves time
- No accuracy impact on training
- Recommended: Always enable

**Use Case 2: Verification** (Conditional benefit)
- Adds confidence scoring â†’ Better quality control
- Adds OCR cost per document
- Recommended: Enable for high-volume or high-stakes

### 3. Separation of Concerns

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OCR Service                           â”‚  â† Extracts text from images
â”‚  (services/ocr/)                       â”‚     (Azure Document Intelligence)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Annotation Service                    â”‚  â† Creates OCR-assisted annotations
â”‚  (services/models/annotation.py)       â”‚     (Uses OCR service)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GEPA Optimizer                        â”‚  â† Trains extraction pipeline
â”‚  (services/gepa/)                      â”‚     (Uses ground truth from annotations)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Verification Service                  â”‚  â† Verifies production extractions
â”‚  (services/models/verification.py)     â”‚     (Uses OCR + trained pipeline)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Schema-Driven Design Throughout

Everything derives from the `ExtractionSchema`:
- OCR annotation knows which fields to look for
- GEPA optimizer creates dynamic signatures
- Verifier knows how to compare field values (type-aware)

---

## Summary

This architecture provides:

âœ… **Modular Design**: Each service is independent
âœ… **Optional Enhancements**: OCR can be enabled/disabled
âœ… **No Breaking Changes**: Existing code still works
âœ… **Clear Data Flow**: Schema â†’ Annotation â†’ Training â†’ Verification
âœ… **Type Safety**: Pydantic models throughout
âœ… **Comprehensive Testing**: Test scripts for each workflow

Ready to build the UI! ğŸš€
